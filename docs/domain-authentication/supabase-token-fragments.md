# Supabase 토큰 조각 최적화

> 쿠키 크기 초과로 인한 인증 에러 해결

**위치**: `supabase/utils/middleware.ts`

## 문제 상황

Supabase 인증 토큰이 커지면 쿠키 크기 제한(4KB)을 초과하여 여러 조각으로 나뉘어 저장됩니다. 이 과정에서 **"Invalid UTF-8 sequence"** 에러가 발생하며 사용자가 예기치 않게 로그아웃됩니다.

### 증상

```
사용자 로그인 → 토큰 조각 쿠키 저장 → 일부 조각 손상 →
파싱 실패 → 자동 로그아웃 → 무한 리디렉션
```

## 해결 방법

### optimizeTokenFragments 함수

미들웨어에서 요청을 가로채 토큰 조각을 검증하고 최적화합니다.

**위치**: `supabase/utils/middleware.ts`

**핵심 아이디어**:

1. 모든 토큰 조각을 번호 순으로 정렬
2. **점진적 파싱**: 조각을 하나씩 추가하며 검증
3. 유효한 토큰이 완성되면 중단
4. 남은 불필요한 조각은 삭제 예약

## 작동 원리

### 1. 토큰 조각 수집

```
쿠키 검색 → sb-*-auth-token.0, .1, .2, ... 수집 → 번호 순 정렬
```

### 2. 점진적 파싱

```
조각1 → 파싱 시도 → 실패 → 조각1+2 → 파싱 시도 → 실패 →
조각1+2+3 → 파싱 시도 → 성공! → 중단
```

**각 시도마다 검증**:

1. base64 디코딩
2. JSON 파싱
3. `access_token`과 `user` 존재 확인

### 3. 불필요한 조각 삭제

유효한 토큰이 완성되면 남은 조각(4번째 이후)을 삭제 예약합니다.

```typescript
// 전역 변수에 삭제 대상 저장
global.invalidTokenFragments = ['sb-xxx-auth-token.3', 'sb-xxx-auth-token.4'];
```

## UTF-8 에러 방지

### 문제

- 토큰 조각이 UTF-8 문자 경계를 깨뜨림
- base64 디코딩 실패 → "Invalid UTF-8 sequence"

### 해결

- 점진적 파싱으로 올바른 조합 찾기
- 실패한 조각은 무시하고 계속 시도
- 완성된 토큰이 나올 때까지 반복

## 무한 리디렉션 방지

### 문제

- 토큰 파싱 실패 → 로그아웃 → 로그인 페이지 리디렉션
- 로그인 성공 → 손상된 토큰 조각 재생성 → 다시 파싱 실패

### 해결

불필요한 조각을 **즉시 삭제**하여 다음 요청에서 깨끗한 상태 유지:

```typescript
response.cookies.delete(fragmentName);
```

## 로깅 시스템

### 활성화

```bash
# 브라우저 콘솔
localStorage.debug = 'token:*'
```

### 로그 레벨

| 레벨          | 내용                      |
| ------------- | ------------------------- |
| `token:info`  | 일반 정보                 |
| `token:warn`  | 경고 (불필요한 조각 발견) |
| `token:error` | 에러 (파싱 실패)          |

### 로그 예시

```
[token:info] 토큰 조각 3개 발견
[token:info] 조각 0-2로 유효한 토큰 완성
[token:warn] 불필요한 조각 1개 삭제 예약: .3
```

## 성능 영향

### 추가 오버헤드

- **시간**: 요청당 ~1-2ms
- **메모리**: 쿠키 파싱 및 조각 조합 (~1KB)

### 최적화

- 유효한 조합을 찾으면 즉시 중단
- 대부분의 경우 2-3회 시도로 완료

## 테스트

### 수동 테스트

1. 개발자 도구 > Application > Cookies
2. `sb-*-auth-token` 조각 확인
3. 임의로 조각 삭제하거나 순서 변경
4. 페이지 새로고침
5. 로그에서 복구 과정 확인

### 자동 테스트

테스트 코드는 없지만, 다음 시나리오를 수동으로 검증:

- 조각이 3개일 때
- 조각이 5개 (불필요한 조각 포함)일 때
- 중간 조각이 누락되었을 때

## 트러블슈팅

### 여전히 로그아웃됨

**원인**: 모든 조각이 손상됨

**해결**:

1. 쿠키 전체 삭제
2. 로그아웃 → 재로그인

### 조각이 계속 증가

**원인**: 조각 삭제가 작동하지 않음

**해결**:

1. 미들웨어 로그 확인
2. `response.cookies.delete()` 호출 여부 확인
3. 브라우저 쿠키 설정 확인

### 파싱은 성공하지만 인증 실패

**원인**: 토큰이 만료됨

**해결**: 재로그인 필요 (정상 동작)

## 주요 파일

- `supabase/utils/middleware.ts` - optimizeTokenFragments 구현
- `debug/token.ts` - 토큰 관련 로거

## 관련 이슈

이 최적화는 다음 문제를 해결합니다:

- **이슈 #XXX**: 무한 로그인 리디렉션
- **이슈 #XXX**: "Invalid UTF-8 sequence" 에러

## 관련 문서

- [사용자 인증: fetchUserId](./fetch-user-id.md)
- [Supabase Auth 공식 문서](https://supabase.com/docs/guides/auth)
